# stream_producer.py
from kafka import KafkaProducer
import json, time, random

producer = KafkaProducer(
    bootstrap_servers='localhost:9092',
    value_serializer=lambda v: json.dumps(v).encode('utf-8')
)

print("ðŸš€ Streaming producer started (topic: demo_topic)")

i = 0
while True:
    message = {"id": i, "value": random.randint(1, 100)}
    producer.send("demo_topic", message)
    print("âœ… Sent:", message)
    i += 1
    time.sleep(2)  # send every 2 seconds

# stream_consumer.py
from kafka import KafkaConsumer
import json

consumer = KafkaConsumer(
    "demo_topic",
    bootstrap_servers="localhost:9092",
    auto_offset_reset="latest",
    value_deserializer=lambda v: json.loads(v.decode('utf-8'))
)

print("ðŸ“¡ Stream consumer listening to topic: demo_topic")

for msg in consumer:
    print("ðŸŸ¢ Received:", msg.value)

# batch_producer.py
from kafka import KafkaProducer
import json

producer = KafkaProducer(
    bootstrap_servers='localhost:9092',
    value_serializer=lambda v: json.dumps(v).encode('utf-8')
)

data = [
    {"id": 1, "name": "Bhanu", "city": "Hyderabad"},
    {"id": 2, "name": "Teja", "city": "Vizag"},
    {"id": 3, "name": "Indla", "city": "Chennai"}
]

for record in data:
    producer.send("demo_topic", record)
    print("âœ… Sent:", record)

producer.flush()
print("ðŸŽ¯ Batch data sent successfully to Kafka topic: demo_topic")


# batch_consumer.py
from kafka import KafkaConsumer
import json
import csv

consumer = KafkaConsumer(
    "demo_topic",
    bootstrap_servers="localhost:9092",
    auto_offset_reset="earliest",
    enable_auto_commit=False,
    value_deserializer=lambda v: json.loads(v.decode('utf-8'))
)

print("ðŸ“¦ Batch consumer reading all messages from topic...")

records = []
for msg in consumer:
    print("ðŸŸ¢ Got:", msg.value)
    records.append(msg.value)

    # Exit after reading 10 messages (simulate batch job)
    if len(records) >= 10:
        break

# Write to CSV
with open("kafka_output.csv", "w", newline="") as f:
    writer = csv.DictWriter(f, fieldnames=records[0].keys())
    writer.writeheader()
    writer.writerows(records)

print("âœ… Wrote", len(records), "messages to kafka_output.csv")
